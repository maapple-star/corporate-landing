---
import ServiceModal from "./service-modal.astro";

interface Props {
  image: string;
  alt: string;
  module: string;
  title: string;
  description: string;
  tags?: string[];
  features?: string[];
  benefits?: string[];
  modalDescription?: string;
  icon?: string;
  quoteHref?: string;
}

const {
  image,
  alt,
  module,
  title,
  description,
  tags,
  features,
  benefits,
  modalDescription,
  icon,
  quoteHref = "#contact",
} = Astro.props;

const hasModal = !!(features?.length || benefits?.length || modalDescription);
const modalId = `svc-modal-${module.toLowerCase().replace(/[^a-z0-9]/g, "-")}`;
---

<div
  class={`svc-card bg-panel border border-border overflow-hidden transition-[border-color,transform] duration-300 ${hasModal ? "cursor-pointer svc-card-clickable" : ""}`}
  data-modal={hasModal ? modalId : undefined}
>
  <div class="relative overflow-hidden">
    <img
      class="svc-img w-full h-[190px] object-cover saturate-[0.3] block transition-[filter] duration-[400ms]"
      src={image}
      alt={alt}
    />
    <div class="absolute inset-0 bg-linear-to-b from-transparent to-panel"></div>
    {
      hasModal && (
        <div class="absolute top-3 right-3 opacity-0 svc-hint transition-opacity duration-200">
          <div class="flex items-center gap-1 bg-panel/80 backdrop-blur-sm border border-border px-2 py-1">
            <svg
              width="10"
              height="10"
              viewBox="0 0 10 10"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle cx="5" cy="5" r="4" stroke="var(--color-cyan)" stroke-width="1" />
              <line
                x1="5"
                y1="3"
                x2="5"
                y2="5.5"
                stroke="var(--color-cyan)"
                stroke-width="1"
                stroke-linecap="round"
              />
              <circle cx="5" cy="7" r="0.6" fill="var(--color-cyan)" />
            </svg>
            <span class="text-[0.55rem] font-orbitron text-cyan tracking-[0.1em] uppercase">Details</span>
          </div>
        </div>
      )
    }
  </div>
  <div class="p-5 pb-6">
    <div class="text-[0.6rem] tracking-[0.2em] text-cyan uppercase mb-[6px]">{module}</div>
    <div class="font-orbitron text-[0.85rem] font-bold uppercase text-white mb-2 tracking-[0.04em]">
      {title}
    </div>
    <p class="text-[0.8rem] text-text leading-[1.7]">{description}</p>
    {
      tags && tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-1">
          {tags.map((tag) => (
            <span class="text-[0.62rem] bg-panel2 text-cyan py-[3px] px-2 border border-border tracking-[0.06em]">
              {tag}
            </span>
          ))}
        </div>
      )
    }
    {
      hasModal && (
        <div class="mt-4 flex items-center gap-2 text-cyan opacity-60">
          <div class="h-px flex-1 bg-border" />
          <span class="text-[0.55rem] font-orbitron tracking-[0.15em] uppercase">View Details</span>
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
            <path d="M2 5h6M5 2l3 3-3 3" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      )
    }
  </div>
</div>

{
  hasModal && (
    <ServiceModal
      id={modalId}
      module={module}
      title={title}
      description={description}
      modalDescription={modalDescription}
      icon={icon}
      features={features}
      benefits={benefits}
      quoteHref={quoteHref}
    />
  )
}

<style>
  .svc-card-clickable:hover .svc-hint {
    opacity: 1;
  }
</style>

<script>
  function initServiceModals() {
    // Move all modals to body so they aren't nested inside card elements
    document.querySelectorAll<HTMLElement>(".svc-modal-overlay").forEach((modal) => {
      if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
      }
    });

    // Open handlers
    document.querySelectorAll<HTMLElement>(".svc-card-clickable").forEach((card) => {
      card.addEventListener("click", () => {
        const modalId = card.dataset.modal;
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.add("is-open");
        document.body.style.overflow = "hidden";
      });
    });

    // Close handlers
    document.querySelectorAll<HTMLElement>("[data-modal-close]").forEach((el) => {
      el.addEventListener("click", (e) => {
        e.stopPropagation();
        const modalId = el.dataset.modalClose;
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.remove("is-open");
        document.body.style.overflow = "";
      });
    });

    // Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      document.querySelectorAll<HTMLElement>(".svc-modal-overlay.is-open").forEach((modal) => {
        modal.classList.remove("is-open");
        document.body.style.overflow = "";
      });
    });
  }

  // Run on initial load and after view transitions
  initServiceModals();
  document.addEventListener("astro:page-load", initServiceModals);
</script>
