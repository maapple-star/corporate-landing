---
import ServiceModal from "./service-modal.astro";

interface Props {
  image: string;
  alt: string;
  title: string;
  description: string;
  tags?: string[];
  features?: string[];
  benefits?: string[];
  modalDescription?: string;
  icon?: string;
  quoteHref?: string;
}

const {
  image,
  alt,
  title,
  description,
  tags,
  features,
  benefits,
  modalDescription,
  icon,
  quoteHref = "#contact",
} = Astro.props;

const hasModal = !!(features?.length || benefits?.length || modalDescription);
const modalId = `svc-modal-${title.toLowerCase().replace(/[^a-z0-9]/g, "-")}`;
---

<div
  class={`svc-card border border-[#e2e8f0] overflow-hidden transition-[border-color,box-shadow] duration-300 ${hasModal ? "cursor-pointer svc-card-clickable" : ""}`}
  data-modal={hasModal ? modalId : undefined}
>
  <img
    class="svc-img w-full h-[180px] object-cover block"
    src={image}
    alt={alt}
  />
  <div class="p-6">
    <div class="font-syne text-[1rem] font-bold text-dark mb-2">
      {title}
    </div>
    <p class="text-[0.82rem] text-mid leading-[1.7]">{description}</p>
    {
      tags && tags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-[6px]">
          {tags.map((tag) => (
            <span class="text-[0.68rem] bg-blue-pale text-blue2 py-[3px] px-[10px] font-medium">
              {tag}
            </span>
          ))}
        </div>
      )
    }
  </div>
</div>

{
  hasModal && (
    <ServiceModal
      id={modalId}
      title={title}
      description={description}
      modalDescription={modalDescription}
      icon={icon}
      features={features}
      benefits={benefits}
      quoteHref={quoteHref}
    />
  )
}

<style>
  .svc-card-clickable:hover .svc-hint {
    opacity: 1;
  }
</style>

<script>
  function initServiceModals() {
    // Move all modals to body so they aren't nested inside card elements
    document.querySelectorAll<HTMLElement>(".svc-modal-overlay").forEach((modal) => {
      if (modal.parentElement !== document.body) {
        document.body.appendChild(modal);
      }
    });

    // Open handlers
    document.querySelectorAll<HTMLElement>(".svc-card-clickable").forEach((card) => {
      card.addEventListener("click", () => {
        const modalId = card.dataset.modal;
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.add("is-open");
        document.body.style.overflow = "hidden";
      });
    });

    // Close handlers
    document.querySelectorAll<HTMLElement>("[data-modal-close]").forEach((el) => {
      el.addEventListener("click", (e) => {
        e.stopPropagation();
        const modalId = el.dataset.modalClose;
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        modal.classList.remove("is-open");
        document.body.style.overflow = "";
      });
    });

    // Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      document.querySelectorAll<HTMLElement>(".svc-modal-overlay.is-open").forEach((modal) => {
        modal.classList.remove("is-open");
        document.body.style.overflow = "";
      });
    });
  }

  // Run on initial load and after view transitions
  initServiceModals();
  document.addEventListener("astro:page-load", initServiceModals);
</script>
